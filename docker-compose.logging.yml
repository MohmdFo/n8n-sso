version: '3.8'

services:
  n8n-sso-gateway:
    build:
      context: .
      dockerfile: Dockerfile.Logging
      target: development
      args:
        BUILD_DATE: "2025-09-13"
        GIT_COMMIT: "${GIT_COMMIT:-unknown}"
        APP_VERSION: "${APP_VERSION:-dev}"
    ports:
      - "8000:8000"
    environment:
      # Container environment detection
      DOCKER_CONTAINER: "true"
      LOG_FORMAT: "json"
      NO_COLOR: "1"
      
      # Application settings
      ENVIRONMENT: "development"
      LOG_LEVEL: "INFO"
      ENABLE_FILE_LOGGING: "true"
      
      # Build metadata
      BUILD_DATE: "2025-09-13"
      GIT_COMMIT: "${GIT_COMMIT:-unknown}"
      APP_VERSION: "${APP_VERSION:-dev}"
      
      # SSO Configuration
      CASDOOR_ENDPOINT: "${CASDOOR_ENDPOINT}"
      CASDOOR_CLIENT_ID: "${CASDOOR_CLIENT_ID}"
      CASDOOR_CLIENT_SECRET: "${CASDOOR_CLIENT_SECRET}"
      CASDOOR_ORGANIZATION_NAME: "${CASDOOR_ORGANIZATION_NAME}"
      CASDOOR_APPLICATION_NAME: "${CASDOOR_APPLICATION_NAME}"
      
      # N8N Configuration
      N8N_DB_HOST: "${N8N_DB_HOST}"
      N8N_DB_PORT: "${N8N_DB_PORT}"
      N8N_DB_USER: "${N8N_DB_USER}"
      N8N_DB_PASSWORD: "${N8N_DB_PASSWORD}"
      N8N_DB_NAME: "${N8N_DB_NAME}"
      N8N_BASE_URL: "${N8N_BASE_URL}"
    
    volumes:
      # Logs volume for development
      - ./logs:/app/logs
      # Config volume
      - ./conf:/app/conf:ro
    
    networks:
      - sso-network
    
    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # Logging configuration for Docker Compose
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service,environment"
    
    # Resource limits
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

  # Log aggregator for development (optional)
  fluent-bit:
    image: fluent/fluent-bit:latest
    volumes:
      - ./logs:/app/logs:ro
      - ./conf/fluent-bit.conf:/fluent-bit/etc/fluent-bit.conf:ro
    ports:
      - "24224:24224"
    networks:
      - sso-network
    profiles:
      - logging

networks:
  sso-network:
    driver: bridge

volumes:
  logs:
    driver: local
